<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:ahsj="http://mybatis.org/schema/mybatis-mapper">

<div th:replace="public/base_list :: html"></div>
<body class="vertical-layout page-header-light vertical-menu-collapsible vertical-menu-nav-dark 2-columns  "
      data-open="click" data-menu="vertical-menu-nav-dark" data-col="2-columns">
<!-- Start Page Loading -->
<div class="row">
    <div class="breadcrumbs-inline pt-3 pb-1" id="breadcrumbs-wrapper">
        <!-- Search for small screen-->
        <div class="container">
            <div class="row">
                <div class="col s10 m6 l6 breadcrumbs-left">
                    <h5 class="breadcrumbs-title mt-0 mb-0 display-inline hide-on-small-and-down">DataTable</h5>
                    <ol class="breadcrumbs mb-0">
                        <li class="breadcrumb-item"><a href="index.html">Home</a>
                        </li>
                        <li class="breadcrumb-item"><a href="#">Table</a>
                        </li>
                        <li class="breadcrumb-item active">DataTable
                        </li>
                    </ol>
                </div>
                <div class="col s2 m6 l6"><a
                        class="btn btn-floating dropdown-settings waves-effect waves-light breadcrumbs-btn right"
                        href="#!" data-target="dropdown1"><i class="material-icons">expand_more </i><i
                        class="material-icons right">arrow_drop_down</i></a>
                    <ul class="dropdown-content" id="dropdown1" tabindex="0">
                        <li tabindex="0"><a class="grey-text text-darken-2"
                                            href="user-profile-page.html">Profile<span
                                class="new badge red">2</span></a></li>
                        <li tabindex="0"><a class="grey-text text-darken-2" href="app-contacts.html">Contacts</a>
                        </li>
                        <li tabindex="0"><a class="grey-text text-darken-2" href="page-faq.html">FAQ</a></li>
                        <li class="divider" tabindex="-1"></li>
                        <li tabindex="0"><a class="grey-text text-darken-2" href="user-login.html">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <form class="col s12" id="send_Form" action="#">
    <div class="col s12 x12 l12 xl12">
        <div class="container">
            <div class="section section-data-tables">
                <div class="card">
                    <div class="card-content">
                        <!--药品用法-->
                        <div class="row">
                            <div class="input-field col s4 l4 xl4">
                                <select ahsj:select name="isSkinTest" id="isSkinTest" type="code" typeKey="is_skin_test" cssClass="">
                                </select>
                                <label for="isSkinTest">是否皮试<span style="font-size: 12px">(Whether skin test
)</span></label>
                            </div>
                            <div class="input-field col s4 l4 xl4">
                            <input id="duration" name="duration" type="number" data-error=".errorTxt3"/>
                            <div class="errorTxt3"></div>
                            <label for="duration">持续时间<span style="font-size: 12px">(duration
                            )</span></label>
                            </div>


                            <div class="input-field col s4 l4 xl4">
                                <input id="usages" name="usages" type="text" data-error=".errorTxt5"/>
                                <div class="errorTxt5"></div>
                                <label for="usages">用法<span style="font-size: 12px">(usage
)</span></label>
                            </div>
                            <div class="input-field col s4 l4 xl4">
                                <input id="dosage" name="dosage" type="text" data-error=".errorTxt6"/>
                                <div class="errorTxt6"></div>
                                <label for="dosage">用量<span style="font-size: 12px">(dosage)</span></label>
                            </div>
                            <div class="input-field col s4 l4 xl4">
                                <select ahsj:select name="intervals" id="intervals" type="code" typeKey="intervals" cssClass="">
                                </select>
                                <label for="intervals">间隔<span style="font-size: 12px">(Interval
)</span></label>
                            </div>
                    </div>

                </div>
            </div>
            <div class="row">
                <div class="col s6 x6 l6 xl6">
                    <div class="card">
                        <div class="card-content">
                            <h4 class="card-title">药品选择
                            </h4><label style="color:black">Drug selection
                        </label>
                            <div class="row">
                                <div class="col s2 m2 l2 xl2 offset-xl10">
                                    <a id="btnAddtoList" class="btn waves-effect waves-light red">
                                        <i class="material-icons  white-text tooltipped " data-position="bottom"
                                           data-delay="50" data-tooltip="新增">playlist_add</i>
                                    </a>
                                </div>
                            </div>
                            <!--Form Advance-->
                            <div class="row">
                                <div id="medicine_list" class="col l12 m12 l12 xl12">
                                    <table id="data-table-simple" class="display">
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col s6 x6 l6 xl6">
                    <div class="card">
                        <div class="card-content">
                            <h4 class="card-title">输液单
                            </h4><label style="color:black">Infusion list
                        </label>
                            <div class="row">
                                <div class="col s2 m2 l2 xl2 offset-xl10">
                                    <a id="btnDeleteFromList"
                                       class="btn waves-effect waves-light red offset-s1 offset-l1 offset-xl1 offset-m1">
                                        <i class="material-icons white-text tooltipped" data-position="bottom"
                                           data-delay="50"
                                           data-tooltip="批量删除">delete</i>
                                    </a>
                                </div>
                            </div>
                            <!--Form Advance-->
                            <form class="col s12" id="send_Form2" action="#">
                                <div class="row">
                                    <div class="col input-field s4 m6 l6 xl6">
                                        <select id="nurseId" name="nurseId" type="text"/>
                                    </div>
                                    <div class="col input-field s4 m6 l6 xl6 jeinput">
                                        <input id="startTime" name="startTime" type="text" class="jeinput" th:value="${startTime}"/>
                                    </div>
                                </div>

                                <div id="enter_medicine_list" class="col l12 m12 l12 xl12">
                                    <table id="data-table-simple-enter">
                                    </table>
                                </div>
                                <div class="row">
                                    <div class="input-field col s12">
                                        <button id="BtnMediEnter" class="btn cyan waves-effect waves-light right" type="submit" name="action" th:style="${saveBtn}">提交(submit
                                            )
                                            <i class="mdi-content-send right"></i>
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    </form>

</div>

<input type="hidden" id="hospitalManage" th:value="${hospitalManage}">
<input type="hidden" id="patientId" th:value="${patientId}">
<input type="hidden" id="number" th:value="${number}">
<input type="hidden" id="nurseIdflag" th:value="${nurseId}">

<div th:replace="public/base_list_script :: html"></div>
<script type="text/javascript" th:src="@{/hiscore/assets/global/js/ahsj.selfdatatable.js}"></script>
<script type="text/javascript">

    var gridEnterList = new AHSJDT();

    var grid = new Datatable();
    $(document).ready(function () {
        initBtn();
        initTable();
    });

    //选择护士
    $(document).ready(function() {
        //病房
        var nurIdSelect  = $("#nurseId");

        var flag = $('#nurseIdflag').val();



        $.getJSON(CTX+"/api/nurse/getNurse.ahsj?&token="+TOKEN, function (result){
            if (flag == null || flag == "" ){
                nurIdSelect.prepend("<option value='0'>选择执行护士</option>");


                $(result).each(function (i) {
                    nurIdSelect.append("<option value='" + this.userId + "'>" + this.name + "</option>")
                });


            }else {
                for (var j = 0;j<result.length;++j){
                    if (flag == result[j].userId){

                        nurIdSelect.append("<option value='" + result[j].userId + "'>" + result[j].name + "</option>");
                    }
                }
                $(result).each(function (i) {
                    nurIdSelect.append("<option value='" + this.userId + "'>" + this.name + "</option>")
                })
            }

            nurIdSelect.formSelect();
        })
    });

    //选择时间（精确
    var enLang = {
        name  : "en",
        month : ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
        weeks : [ "SUN","MON","TUR","WED","THU","FRI","SAT" ],
        times : ["Hour","Minute","Second"],
        timetxt: ["Time","Start Time","End Time"],
        backtxt:"Back",
        clear : "Clear",
        today : "Now",
        yes   : "Confirm",
        close : "Close"
    }
    jeDate("#startTime",{
        theme:{bgcolor:"#00A1CB",pnColor:"#00CCFF"},
        // festival:true,
        minDate:"1900-01-01",              //最小日期
        maxDate:"2099-12-31",              //最大日期
        // method:{
        //     choose:function (params) {
        //
        //     }
        // },
        format: "YYYY-MM-DD hh:mm:ss"
    });



    function initTable() {
        //选择列表
        grid.init({
            src: $("#data-table-simple"),
            onSuccess: function (grid) {
            },
            onError: function (grid) {
            },
            onDataLoad: function (grid) {
            },
            loadingMessage: 'Loading...',
            dataTable: {
                "ajax": {
                    "url": CTX + "/api/medicationDetails/useDrugDetails.ahsj?token=" + TOKEN+"&medicalNumber="+$("#hospitalManage").val(), // ajax source
                },
                "columns": [
                    {
                        "title": "<label><input type=\"checkbox\"  id=\"checkAll\" class=\"select-all\" > <span></span></label> ",
                        "render": function (data, type, row, meta) {
                            return " <label> <input type=\"checkbox\" value=\"" + row.medicationId + "\"> <span></span> </label>";
                        },
                        "width": "18px",
                        "orderable": false,
                        "className": "centered"
                    },
                    {
                        "title": "药品名称",
                        "data": "drugsName", //实体字段
                        "name": "drugs_name"   //库中字段
                    },
                    {
                        "title": "药品规格",
                        "data": "drugsSpec",
                        "name": "drugs_spec"
                    },
                    {
                        "title": "药品数目",
                        "data": "count",
                        "name": "count"
                    },
                    {
                        "title": "单价",
                        "data": "salePrice",
                        "name": "sale_price"
                    },
                    {
                        "title": "单项总价",
                        "data": "price",
                        "name": "price"
                    },
                    {
                        "title": "是否付费",
                        "data": "isPayName",
                        "name": "is_pay"
                    },
                    {
                        "title": "已添加数目",
                        "data": "alreadyout",
                        "name": "alreadyout"
                    },
                    {
                        "title": "操作",
                        "width": "60px",
                        "className": "centered",
                        "orderable": false,
                        "render": function (data, type, row) {
                            var rtnBtn = "";
                            //如果获取字符串，必须在参数外反转"

                            if (row.remarks < row.count){
                                rtnBtn = rtnBtn + "<a class='tooltipped' data-position=\"bottom\"  data-delay=\"50\" data-tooltip=\"添加至待采购列表\" href='javascript:;' onclick=add("+row.id+","+row.medicationId+",'" + row.drugsName + "','" +row.drugsSpec+"','"+row.smallUnit+"',"+row.count+","+row.price+");>" +
                                    " <i class='material-icons'>add</i></a>";
                            }

                            // 返回自定义内容
                            return rtnBtn;
                        }
                    }
                ],
                "order": [
                    [2, 'asc']
                ]
            }
        });

// 待添加列表
        gridEnterList.init({
            src: $("#data-table-simple-enter"),
            theads: [
                {
                    "title": "药品名称",
                    "data": "drugsName", //实体字段
                    "name": "drugsName"   //库中字段
                },
                {
                    "title": "单次剂量",
                    "width": "120px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        rtnBtn = rtnBtn +
                            " <input id='singledose' name='singledose' type='number'/>";
                        // 返回自定义内容
                        return rtnBtn;
                    }
                },
                {
                    "title": "药品规格",
                    "data": "drugsSpec",
                    "name": "drugs_spec"
                },
                {
                    "title": "用量",
                    "data": "count",
                    "name": "count"
                },
                {
                    "title": "单位",
                    "data": "smallUnit",
                    "name": "small_unit"
                },
                {
                    "title": "总价",
                    "data": "price",
                    "name": "price"
                },
                {
                    "title": "操作",
                    "width": "120px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        rtnBtn = rtnBtn +
                            "<a class='tooltipped' data-position=\"bottom\"  data-delay=\"50\" data-tooltip=\"移除\" onclick='remove(" + row.id + ");'> <i class='material-icons'>delete</i></a>";
                        // 返回自定义内容
                        return rtnBtn;
                    }
                }
            ],
        });


    }

    //添加到list里
    function add(id,medicationId,drugsName,drugsSpec,smallUnit,count,price) {
        var selectRowsIds = gridEnterList.getIds();
        if (selectRowsIds.length !== 0) {
            for (var k = 0; k < selectRowsIds.length; k++) {
                if (id == selectRowsIds[k]) {
                    id = null;
                }
            }
        }
        if (null !== id) {
            gridEnterList.addRow({"id":id,"medicationId":medicationId, "drugsName": drugsName,"drugsSpec":drugsSpec,"smallUnit":smallUnit,"count":count,"price":price});
        }
    }

    //移除一列
    function remove(id) {
        gridEnterList.removeRow(id);
    }

    function initBtn() {
        //批量添加按钮
        $("#btnAddtoList").click(function () {
            var ids = grid.getSelectedRows();
            if (ids.length == 0) {
                dialog.warn("请至少选择一条数据");
                return;
            }
            var json = grid.getDataTable().ajax.json();
            var selectRowsIds = gridEnterList.getIds();
            var tmps = [];
            if (selectRowsIds.length !== 0) {
                for (var i = 0; i < ids.length; i++) {
                    for (var k = 0; k < selectRowsIds.length; k++) {
                        if (ids[i] == selectRowsIds[k]) {
                            delete(ids[i]);
                        }
                    }
                }
            }
            for (var i = 0; i < ids.length; ++i) {
                for (var j = 0; j < json.data.length; j++) {
                    if (undefined !== ids[i] && '' !== ids[i] && null != ids[i] && json.data[j].id == ids[i]) {
                        tmps[i] = {
                            "medicationId": json.data[j].medicationId,
                            "id": json.data[j].id,
                            "drugsName": json.data[j].drugsName,
                            "drugsSpec": json.data[j].drugsSpec,
                            "smallUnit": json.data[j].smallUnit,
                            "count": json.data[j].count,
                            "price": json.data[j].price
                        }
                    }
                }
            }
            gridEnterList.addRows(tmps);
            grid.initCheckbox();
        });
        $("#btnDeleteFromList").click(function () {
            var ids = gridEnterList.getSelectedRows();
            if (ids.length == 0) {
                dialog.warn("请至少选择一条数据");
                return;
            }
            gridEnterList.removeRows(ids);
        });



    }

    $("#send_Form").validate({
        rules: {
            nurseId: {//1
                required: true,
                minlength: 1
            },
            startTime: {//2
                required: true,
                minlength: 1
            },
            isSkinTest: {//2
                required: true,
                minlength: 1
            },
            duration: {//2
                required: true,
                minlength: 1
            },
            // unit: {//2
            //     required: true,
            //     minlength: 1
            // },
            usages: {//2
                required: true,
                minlength: 1
            },
            dosage: {//2
                required: true,
                minlength: 1
            },
            intervals: {//2
                required: true,
                minlength: 1
            }
        },
        messages: {
            nurseId: {
                required: "请填写执行护士",
                minlength: "最少包含1个字符"
            },
            startTime:{
                required: "请选择时间",
                minlength: "最少包含1个字符"
            },
            isSkinTest:{
                required: "请选择是否皮试",
                minlength: "最少包含1个字符"
            },
            duration:{
                required: "请填写持续时间",
                minlength: "最少包含1个字符"
            },
            // unit:{
            //     required: "请选择单位",
            //     minlength: "最少包含1个字符"
            // },
            usages:{
                required: "请选择用法",
                minlength: "最少包含1个字符"
            },
            dosage:{
                required: "请选择用量",
                minlength: "最少包含1个字符"
            },
            intervals:{
                required: "请选择间隔",
                minlength: "最少包含1个字符"
            }
        },
        errorElement: 'div',
        errorPlacement: function (error, element) {
            var placement = $(element).data('error');
            if (placement) {
                $(placement).append(error)
            } else {
                error.insertAfter(element);
            }
        },
        submitHandler: function (form) {



            dialog.confirm('确定提交吗?', function (index, layero){
                // var buyplanId = (new Date()).getTime();
                medicationIds = gridEnterList.getIds();
                singledoses = gridEnterList.getSingledose();
                // counts = gridEnterList.



                // var flag = true;

                var nurseId=$("#nurseId").val();
                var startTime=$("#startTime").val();
                var isSkinTest=$("#isSkinTest").val();
                var duration=$("#duration").val();
                // var units=$("#unit").val();
                var usages=$("#usages").val();
                var dosages=$("#dosage").val();
                var intervals=$("#intervals").val();
                var hospitalManageId = $("#hospitalManage").val();
                var patientId = $("#patientId").val();

                // for (i = 0 ; i<singledoses.length ;++i){
                //     if (singledoses[i] > )
                // }

                $.ahsjajax(CTX + "/api/hisInfusion/save.ahsj",
                    {
                        "medicationIds": medicationIds.join(','),//采购药品id
                        "singledoses":singledoses.join(','), //单次剂量
                        "nurseId":nurseId,//负责人
                        "startTime":startTime,//预期时间
                        "isSkinTest":isSkinTest,//是否皮试
                        "duration":duration,//持续时间
                        // "units":units,//单位
                        "usages":usages,//用法
                        "dosages":dosages,//用量
                        "intervals":intervals,//间隔
                        "hospitalManageId":hospitalManageId,//就诊记录编号
                        "patientId":patientId//病人id
                    },
                    function (msg) {
                        if (msg.success) {
                            M.toast({html: msg.message});
                            parent.grid.search();
                            dialog.parentclose();
                            return false;
                        } else {
                            M.toast({html: msg.message});
                            return false;
                        }
                    },
                    function (data) {
                        M.toast({
                            html: "网络异常", completeCallback: function () {
                            }
                        });
                    }
                );
            });


        }
    });


    $("input").change(function(){
        $(this).val($(this).val().trim());
    });

</script>
</body>
</html>