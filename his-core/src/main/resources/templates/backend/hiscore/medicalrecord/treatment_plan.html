<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<div th:replace="public/base_update :: html"></div>

<body class="vertical-layout page-header-light vertical-menu-collapsible vertical-menu-nav-dark 2-columns  "
      data-open="click" data-menu="vertical-menu-nav-dark" data-col="2-columns">

<div class="row">
    <div class="input-field col s2 x2 m2 l2 xl2" >
        <input type="hidden" id="demo" class="datepicker" name="demo">
    </div>

</div>
<div class="row">
    <div id="validation" class="card">
        <div class="card-content">
            <div class="card-header">
                <h4 class="card-title">门诊流程</h4>
            </div>
            <form class="col s12" id="patientMediReForm" onsubmit="return false;" action="#" method="post">
                <ul class="stepper horizontal" id="horizStepper" style="min-height:726px;">
                    <li class="step active">
                        <div class="step-title waves-effect">门 诊 病 历</div><label>Outpatient medical record</label>
                        <div class="step-content">
                            <div th:if="${true}">
                                <div class="row">
                                    <div class="col s2 m2 l2 xl2 right">
                                        <a id="addMedicalTemplate"
                                           class="btn waves-effect waves-light red " >
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="使用病历模板（Use medical record template）">note_add</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" id="recordId" name="recordId" th:value="${recordId}">
                            <div class="row">
                                <div class="input-field col s2 x2 m2 l2 xl2 jeinpbox">
                                    <input type="hidden" name="id" th:value="${hisMedical.id}" id="id"/>
                                    <input type="hidden" name="number" th:value="${number}" id="number"/>
                                    <input type="text" id="noSetDate" class="jeinput" name="noSetDate"
                                           readonly="readonly" autocomplete="off"
                                           th:placeholder="${#dates.format(hisMedical.noSetDate, 'yyyy-MM-dd HH:mm:ss')}"
                                           th:value="${#dates.format(hisMedical.noSetDate, 'yyyy-MM-dd HH:mm:ss')}">
                                    <label for="noSetDate" class="active">发 病 时 间<span style="font-size: 12px">(Time of onset

)</span></label>
                                </div>

                            </div>
                            <div class="row">
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="chiefcomplaint" class="materialize-textarea"
                                              th:text="${hisMedical.chiefcomplaint}"
                                              name="chiefcomplaint" data-length="255"></textarea>
                                    <label for="chiefcomplaint" class="active">主 诉<span style="font-size: 12px">(Chief complaint

)</span></label>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="hiscondition" class="materialize-textarea"
                                              th:text="${hisMedical.hiscondition}"
                                              name="hiscondition"
                                              data-length="255"></textarea>
                                    <label for="hiscondition" class="active">既 往 病 史<span style="font-size: 12px">(Past medical history

)</span></label>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="nowCondition" class="materialize-textarea"
                                              th:text="${hisMedical.nowCondition}"
                                              name="nowCondition"
                                              data-length="255"></textarea>
                                    <label for="nowCondition" class="active">现 在 病 史<span style="font-size: 12px">(Current medical historyន

)</span></label>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="personalHistory" class="materialize-textarea"
                                              th:text="${hisMedical.personalHistory}"
                                              name="personalHistory"
                                              data-length="255"></textarea>
                                    <label for="personalHistory" class="active">个 人 史<span style="font-size: 12px">(Personal history

)</span></label>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="allergies" class="materialize-textarea"
                                              name="allergies"
                                              th:text="${hisMedical.allergies}"
                                              data-length="255">
                                    </textarea>
                                    <label for="allergies">过 敏 史<span style="font-size: 12px">(allergies

)</span></label>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                                                    <textarea type="text" id="familyHistory"
                                                                              class="materialize-textarea"
                                                                              name="familyHistory"
                                                                              th:text="${hisMedical.familyHistory}"
                                                                              data-length="255">
                                                                    </textarea>
                                    <label for="familyHistory">家 族 史<span style="font-size: 12px">(Family history

)</span></label>
                                </div>
                                <div class="row">
                                    <h6 class="col s2 x2 m2 l2 xl2">
                                        体格检查<span style="font-size: 12px">(Physical examination)</span>
                                    </h6>
                                    <div class="input-field col s2 x2 m2 l2 xl2">
                                        <input type="number" id="bodyTemperature" name="bodyTemperature" min="16.00" step="0.01" max="48.00"
                                               th:value="${hisMedical.bodyTemperature}" class="active">
                                        <label for="bodyTemperature">体 温（ ℃） <span style="font-size: 12px">(body temperature  ℃

)</span></label>
                                    </div>
                                    <div class="input-field col s2 x2 m2 l2 xl2">
                                        <input type="number" id="bodyWeight" name="bodyWeight" min="0.00" step="0.01"
                                               th:value="${hisMedical.bodyWeight}">
                                        <label for="bodyWeight">体 重 （KG） <span style="font-size: 12px">(weight KG

)</span></label>
                                    </div>
                                    <div class="input-field col s2 x2 m2 l2 xl2">
                                        <input type="number" id="heartRate" name="heartRate" min="1" max="255" step="1" onkeyup="value=value.replace(/^(0+)|[^\d]+/g,'')"
                                               th:value="${hisMedical.heartRate}">
                                        <label for="heartRate">心 率 （bpm）<span style="font-size: 12px">(Heart rate bpm

)</span></label>
                                    </div>
                                    <div class="input-field col s2 x2 m2 l2 xl2">
                                        <input type="text" id="bloodPressure" class="text" name="bloodPressure"
                                               th:value="${hisMedical.bloodPressure}">
                                        <label for="bloodPressure">血 压（mmhg） <span style="font-size: 12px">(blood pressure mmhg

)</span></label>
                                    </div>
                                </div>
                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="other" class="materialize-textarea" name="other"
                                              th:text="${hisMedical.other}"
                                              data-length="255"></textarea>
                                    <label for="other" class="active">其他结果<span style="font-size: 12px">(Other results
)</span></label>
                                </div>

                                <div class="input-field col s12 x12 m12 l12 xl12">
                                    <textarea type="text" id="remarks" class="materialize-textarea" name="remarks"
                                              th:text="${hisMedical.remarks}"
                                              data-length="255"></textarea>
                                    <label for="remarks" class="active">备 注<span style="font-size: 12px">(remark
)</span></label>
                                </div>
                            </div>
                            <div class="step-actions" style="position: relative;bottom: 1px">
                                <div class="row">
                                    <div class="col m4 s12 mb-3" style="width: auto" th:if="${isSameUser}">
                                        <button class="red btn btn-reset" type="reset">
                                            <i class="material-icons left">clear</i>重置
                                        </button>
                                    </div>
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="btn btn-light previous-step" disabled>
                                            <i class="material-icons left">arrow_back</i>上一步
                                        </button>
                                    </div>
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="waves-effect waves dark btn btn-primary next-step"
                                                id="recordSendBtn"
                                                type="submit">下一步
                                            <i class="material-icons right">arrow_forward</i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>
                    <li class="step">
                        <div class="step-title waves-effect">检 查 治 疗</div>
                        <div class="step-content">
                            <div th:if="${true}">
                                <div class="row">
                                    <div class="col s3 m3 l3 xl3 right">
                                        <a id="addProjectBtn"
                                           class="btn waves-effect waves-light red " th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="新增检查项目">add</i>
                                        </a>
                                        <a id="addProjectsBtn"
                                           class="btn waves-effect waves-light red " th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="使用检查项目组合">note_add</i>
                                        </a>
                                        <a id="deleteProjectListBtn"
                                           class="btn waves-effect waves-light red" th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="批量移除检查项目明细">remove</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div id="planList" class="col l12 m12 l12 xl12">
                                    <table id="data-table-simple-project">
                                    </table>
                                </div>
                            </div>
                            <div class="step-actions" style="position: relative;bottom: 1px">
                                <div class="row">
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="red btn btn-reset" type="reset" th:if="${isSameUser}">
                                            <i class="material-icons left">clear</i>重置
                                        </button>
                                    </div>
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="btn btn-light previous-step">
                                            <i class="material-icons left">arrow_back</i>上一步
                                        </button>
                                    </div>
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="waves-effect waves dark btn btn-primary next-step"
                                                type="submit">下一步<i class="material-icons right">arrow_forward</i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </li>
                    <li class="step">
                        <div class="step-title waves-effect">药 品 处 方</div>
                        <div class="step-content">
                            <!--<div th:if="${isSameUser}">-->
                            <div th:if="${true}">
                                <div class="row">
                                    <div class="col s3 m3 l3 xl3 right">
                                        <a id="addBtn"
                                           class="btn waves-effect waves-light red " th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="新增药品">add</i>
                                        </a>
                                        <a id="addByPrescriptionBtn"
                                           class="btn waves-effect waves-light red " th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="使用药方模版">note_add</i>
                                        </a>
                                        <a id="deleteListBtn"
                                           class="btn waves-effect waves-light red" th:if="${isSameUser}">
                                            <i class="material-icons white-text tooltipped" data-position="bottom"
                                               data-delay="50"
                                               data-tooltip="批量移除药品处方明细">remove</i>
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div id="medicineList" class="col l12 m12 l12 xl12">
                                    <table id="data-table-simple-medicine">
                                    </table>
                                </div>
                            </div>
                            <div class="step-actions" style="position: relative;bottom: 1px">
                                <div class="row">
                                    <div class="col m6 s12 mb-1" style="width: auto;margin-bottom: 5% !important;">
                                        <button class="waves-effect waves-dark btn btn-primary" id="saveBtn"
                                                type="submit" >保存为模板（Save as template）
                                        </button>
                                    </div>
                                    <div class="col m4 s12 mb-3" style="width: auto">
                                        <button class="btn btn-light previous-step">
                                            <i class="material-icons left">arrow_back</i>上一步
                                        </button>
                                    </div>
                                    <div class="col m6 s12 mb-1" style="width: auto;margin-bottom: 5% !important;">
                                        <button class="red btn mr-1 btn-reset" style="margin-right: -1% !important "
                                                type="reset" th:if="${isSameUser}">
                                            <i class="material-icons left">clear</i>
                                            重置
                                        </button>

                                    </div>
                                    <div class="col m6 s12 mb-1" style="width: auto;margin-bottom: 5% !important;">
                                        <button class="waves-effect waves-dark btn btn-primary" id="sendBtn"
                                                type="submit" th:if="${isSameUser}">提交
                                        </button>
                                    </div>
                                    <div class="col m6 s12 mb-1" style="width: auto;margin-bottom: 5% !important;">
                                        <button class="waves-effect waves-dark btn btn-primary" id="printShow"
                                                type="button" >打印
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </li>

                </ul>
            </form>
        </div>
    </div>
</div>

<div th:replace="public/base_list_script :: html"></div>
<div th:replace="public/base_update_script :: html"></div>
<script th:src="@{/hiscore/assets/app-assets/vendors/materialize-stepper/materialize-stepper.min.js}"
        type="text/javascript"></script>
<script type="text/javascript" th:src="@{/hiscore/assets/global/js/ahsj.selfdatatable.js}"></script>
<script type="text/javascript" th:src="@{/hiscore/assets/global/js/plugins/jedate.js}"></script>


<script th:inline="javascript">
    var isSameUser = [[${isSameUser}]];
    var medicineList = new AHSJDT();
    var projectList = new AHSJDT();


    function initcharacterCounter() {
        $('input#input_text, textarea#textarea1').characterCounter();

    }

    function initMedicineList() {
        medicineList.init({
            src: $("#data-table-simple-medicine"),
            theads: [
                {
                    "title": "药品编号",
                    "data": "drugsNumb",
                    "name": "drugs_numb"
                },
                {
                    "title": "药品名称",
                    "data": "drugsName",
                    "name": "drugs_name"
                }, {
                    "title": "药品别名",
                    "data": "drugsAlias",
                    "name": "drugs_alias"
                },
                {
                    "title": "药品规格",
                    "data": "drugsSpec",
                    "name": "drugs_spec"
                },
                {
                    "title": "数量",
                    "width": "80px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        if (!isNullOrEmpty(row.count)) {
                            rtnBtn = rtnBtn +
                                " <input id='count' name='count' type='number' value='" + row.count + "'/>"
                        } else {
                            rtnBtn = rtnBtn +
                                " <input id='count' name='count' type='number' value='" + "'/>"
                        }
                        // 返回自定义内容
                        return rtnBtn;
                    }
                },
                {
                    "title": "用法用量",
                    "width": "300px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        if (!isNullOrEmpty(row.description)) {
                            rtnBtn = rtnBtn +
                                " <textarea id='description' name='description' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + row.description + "' >" + row.description + "</textarea>"
                        } else {
                            rtnBtn = rtnBtn +
                                " <textarea id='description' name='description' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + "' >" + "</textarea>"

                        }
                        // 返回自定义内容
                        return rtnBtn;
                    }
                },
                {
                    "title": "备注",
                    "width": "300px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        if (!isNullOrEmpty(row.remarks)) {
                            rtnBtn += "<textarea id='remarks' name='remarks' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + row.remarks + "' >" + row.remarks + "</textarea>"
                        } else {
                            rtnBtn += "<textarea id='remarks' name='remarks' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + "'>" + "</textarea>"
                        }
                        // 返回自定义内容
                        return rtnBtn;
                    }
                },
                {
                    "title": "操作",
                    "width": "120px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        if (isSameUser) {

                            //如果获取字符串，必须在参数外反转"
                            rtnBtn = rtnBtn +
                                "<a class='tooltipped' data-position=\"bottom\"  data-delay=\"50\" data-tooltip=\"移除\" onclick='remove(" + row.id + ");'> <i class='material-icons'>remove</i></a>";
                        }
                        // 返回自定义内容
                        return rtnBtn;
                    },
                }
            ],
            datas: [[${hisMedicalDetailList}]]
        });
    }

    function initProjectList() {
        projectList.init({
            src: $("#data-table-simple-project"),
            theads: [
                {
                    "title": "项目编号",
                    "data": "number",
                    "name": "number"
                },
                {
                    "title": "项目名称",
                    "data": "name",
                    "name": "name"
                }, {
                    "title": "拼音码",
                    "data": "pinyinCode",
                    "name": "pinyinCode"
                }, {
                    "title": "描述",
                    "data": "description",
                    "name": "description"
                },
                {
                    "title": "类型",
                    "data": "assitTypeName",
                    "name": "type"
                }, {
                    "title": "收费标准",
                    "data": "price",
                    "name": "price"
                }, {
                    "title": "数量",
                    "width": "80px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        if (!isNullOrEmpty(row.hisProjectNum)) {
                            rtnBtn = rtnBtn +
                                " <input id='num' name='num' type='number' value='" + row.hisProjectNum + "' />"
                        } else {
                            rtnBtn = rtnBtn +
                                " <input id='num' name='num' type='number' value='" + "' />"
                        }
                        // 返回自定义内容
                        return rtnBtn;
                    }
                }, {
                    "title": "单位",
                    "data": "unit",
                    "name": "unit"
                },
                {
                    "title": "备注",
                    "width": "300px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        var remarks = row.remarks;
                        if (typeof (remarks) == "undefined") {
                            remarks = "";
                        }

                        if (!isNullOrEmpty(row.remarks)) {
                            rtnBtn = rtnBtn +
                                "<textarea id='remarks' name='remarks' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + remarks + "' >" + remarks + "</textarea>";
                        } else {
                            rtnBtn = rtnBtn +
                                "<textarea id='remarks' name='remarks' style='min-height: 3.4rem' class='materialize-textarea' type='text' value='" + "' >" + "</textarea>";
                        }

                        // 返回自定义内容
                        return rtnBtn;
                    }
                },
                {
                    "title": "操作",
                    "width": "120px",
                    "className": "centered",
                    "render": function (row) {
                        var rtnBtn = "";
                        //如果获取字符串，必须在参数外反转"
                        if (isSameUser) {
                            rtnBtn = rtnBtn +
                                "<a class='tooltipped' data-position=\"bottom\"  data-delay=\"50\" data-tooltip=\"移除\" onclick='removeForProject(" + row.id + ");'> <i class='material-icons'>remove</i></a>";
                        }
                        // 返回自定义内容
                        return rtnBtn;
                    },
                }
            ],
            datas: [[${hisMedicalProjectList}]]
        });
    }

    $(document).ready(function () {
        var enLang = {
            name: "en",
            month: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
            weeks: ["SUN", "MON", "TUR", "WED", "THU", "FRI", "SAT"],
            times: ["Hour", "Minute", "Second"],
            timetxt: ["Time", "Start Time", "End Time"],
            backtxt: "Back",
            clear: "Clear",
            today: "Now",
            yes: "Confirm",
            close: "Close"
        }
        jeDate("#noSetDate", {
            theme: {bgcolor: "#00A1CB", pnColor: "#00CCFF"},
            minDate: "1900-01-01",              //最小日期
            maxDate: "2099-12-31",              //最大日期
            method: {
                choose: function (params) {

                }
            },
            format: "YYYY-MM-DD hh:mm:ss"
        });
        initBtn();
        initStepper();
        initcharacterCounter();
        initMedicineList();
        initProjectList();
        numberCheck();
        initTextareaAutoResize();
    });

    function initBtn() {
        if (isSameUser) {
            //药品明细
            $("#addBtn").click(function () {
                var url = CTX + "/api/pharmacy/listForMedication/index.ahsj?token=" + TOKEN;
                dialog.show(url, "药品信息添加药品处方")
            });
            $("#addByPrescriptionBtn").click(function () {
                var url = CTX + "/api/treatmentplan/prescription/index.ahsj?token=" + TOKEN;
                dialog.show(url, "使用药方模版添加药品处方")
            });
            $("#deleteListBtn").click(function () {
                var ids = medicineList.getSelectedRows();
                if (ids.length == 0) {
                    dialog.warn("请至少选择一条数据");
                    return;
                }
                medicineList.removeRows(ids);
            });
            //收费项目明细
            $("#addProjectBtn").click(function () {
                var url = CTX + "/api/treatmentplan/project/index.ahsj?token=" + TOKEN + "&isSameDepart=" + "true";
                dialog.show(url, "项目信息添加收费项目")
            });
            $("#addProjectsBtn").click(function () {
                var url = CTX + "/api/treatmentplan/combine/index.ahsj?token=" + TOKEN;
                dialog.show(url, "使用收费项目组合模版添加收费项目")
            });
            $("#deleteProjectListBtn").click(function () {
                var ids = projectList.getSelectedRows();
                if (ids.length == 0) {
                    dialog.warn("请至少选择一条数据");
                    return;
                }
                projectList.removeRows(ids);
            });

            //使用病历模板
            $("#addMedicalTemplate").click(function () {
                var url = CTX + "/api/medicalTemplate/listForMedical/index.ahsj?token=" + TOKEN;
                dialog.show(url, "使用病历模板(Use medical record template)")
            });

            //提交按钮
            $("#sendBtn").click(function () {
                dialog.confirm('确定提交吗?', function (index, layero) {
                    //判断血压的正则表达式，血压范围为1-255  格式为90/140   数字（1-255）/数字（1-255）
                    var reg = new RegExp(/^(\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)[/](\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)$/);
                    var bloodPressure = $("#bloodPressure").val();
                    if (!isNullOrEmpty(bloodPressure)) {
                        if (reg.test(bloodPressure)) {
                        } else {
                            dialog.warn("所输入的血压不符合格式要求或超出正常范围！参考格式：90/140")
                            return;
                        }
                    }
                    // 判断体温是否正常，这里的表示体温在16-48之间，包括浮点数,思路：把判断范围与判断格式分开来写，这样容易理解且分开易维护
                    var regBodyTemperature =  new RegExp(/^\d+(\.\d{0,2})?$/);
                    var bodyTemperature =$("#bodyTemperature").val();
                    if (!isNullOrEmpty(bodyTemperature)) {
                        if (bodyTemperature < 16.00 || bodyTemperature > 48.00 || !regBodyTemperature.test(bodyTemperature)) {
                            dialog.warn("所输入的人体温度不符合格式/超出正常范围！本系统范围：16.00-48.00，数据格式为：整数或1-2位小数（37/37.1/37.11）");
                            return;
                        }
                    }

                    var regHeartRate = new RegExp(/^(\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)$/);
                    var heartRate =$("#heartRate").val();
                    if (!isNullOrEmpty(heartRate)) {
                        if (!regHeartRate.test(heartRate)) {
                            dialog.warn("所输入的心率超出正常范围！本系统范围：1-255");
                            return;
                        }
                    }
                    // handleTextArea();
                    var mediCard = {
                        "recordId": $("#recordId").attr("value"),
                        "id": $("#id").val(),
                        "noSetDate": $("#noSetDate").val(),
                        "bloodPressure": $("#bloodPressure").val(),
                        "chiefcomplaint": $("#chiefcomplaint").val(),
                        "hiscondition": $("#hiscondition").val(),
                        "nowCondition": $("#nowCondition").val(),
                        "personalHistory": $("#personalHistory").val(),
                        "allergies": $("#allergies").val(),
                        "familyHistory": $("#familyHistory").val(),
                        "bodyTemperature": $("#bodyTemperature").val(),
                        "bodyWeight": $("#bodyWeight").val(),
                        "heartRate": $("#heartRate").val(),
                        "other": $("#other").val(),
                        "remarks": $("#remarks").val()
                    };
                    var mediDetail = [];
                    var mediList = medicineList.getTableDatas();
                    var projectDetail = [];
                    $("#data-table-simple-medicine > tbody > tr").each(function () {
                        var tmp = {
                            "id": $("input[name='id']", this).val(),
                            "count": $("input[name='count']", this).val(),
                            "description": $("textarea[name='description']", this).val(),
                            "remarks": $("textarea[name='remarks']", this).val(),
                        };
                        if (!isNullOrEmpty(tmp.id) && !isNullOrEmpty(tmp.count)) {
                            mediDetail.push(tmp);
                        }

                    });
                    var d1 = medicineList.getTableDatas();
                    var d2 = projectList.getTableDatas();
                    $("#data-table-simple-project > tbody > tr").each(function () {
                        var tmp = {
                            "id": $("input[name='id']", this).val(),
                            "num": $("input[name='num']", this).val(),
                            "remarks": $("textarea[name='remarks']", this).val(),
                        };
                        if (!isNullOrEmpty(tmp.id) && !isNullOrEmpty(tmp.num)) {
                            projectDetail.push(tmp);
                        }


                    });
                    var hisMedicalModel = {
                        "recordId": $("#recordId").val(),
                        "mediCard": mediCard,
                        "mediDetail": mediDetail,
                        "projects": projectDetail
                    };
                    var jsonData = JSON.stringify(hisMedicalModel);
                    $.ahsjajax(
                        CTX + "/api/treatmentplan/saveOrUpdate.ahsj",
                        jsonData,
                        function (msg) {
                            if (msg.success) {
                                M.toast({html: msg.message});
                                printShow();
                                return false;
                            } else {
                                M.toast({html: msg.message});
                                return false;
                            }
                        },
                        null, null, null, function () {
                            M.toast({html: "网络异常"});
                            return false;
                        }, "application/json; charset=UTF-8"
                    );
                });
            });

            $("#saveBtn").click(function () {
                layer.confirm('<input id="templateName" name="templateName">', {icon: 1, title:'请输入模板名称（Please enter a template name）'}, function(index){
                    //do something
                    //判断血压的正则表达式，血压范围为1-255  格式为90/140   数字（1-255）/数字（1-255）
                    var reg = new RegExp(/^(\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)[/](\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)$/);
                    var bloodPressure = $("#bloodPressure").val();
                    if (!isNullOrEmpty(bloodPressure)) {
                        if (reg.test(bloodPressure)) {
                        } else {
                            dialog.warn("所输入的血压不符合格式要求或超出正常范围！参考格式：90/140")
                            return;
                        }
                    }
                    // 判断体温是否正常，这里的表示体温在16-48之间，包括浮点数,思路：把判断范围与判断格式分开来写，这样容易理解且分开易维护
                    var regBodyTemperature =  new RegExp(/^\d+(\.\d{0,2})?$/);
                    var bodyTemperature =$("#bodyTemperature").val();
                    if (!isNullOrEmpty(bodyTemperature)) {
                        if (bodyTemperature < 16.00 || bodyTemperature > 48.00 || !regBodyTemperature.test(bodyTemperature)) {
                            dialog.warn("所输入的人体温度不符合格式/超出正常范围！本系统范围：16.00-48.00，数据格式为：整数或1-2位小数（37/37.1/37.11）");
                            return;
                        }
                    }

                    var regHeartRate = new RegExp(/^(\b25[0-5]\b|\b2[0-4]\d\b|\b1\d\d\b|\b[1-9]\d\b|\b[1-9]\b)$/);
                    var heartRate =$("#heartRate").val();
                    if (!isNullOrEmpty(heartRate)) {
                        if (!regHeartRate.test(heartRate)) {
                            dialog.warn("所输入的心率超出正常范围！本系统范围：1-255");
                            return;
                        }
                    }
                    // handleTextArea();
                    var mediCard = {
                        "recordId": $("#recordId").attr("value"),
                        "id": $("#id").val(),
                        "noSetDate": $("#noSetDate").val(),
                        "bloodPressure": $("#bloodPressure").val(),
                        "chiefcomplaint": $("#chiefcomplaint").val(),
                        "hiscondition": $("#hiscondition").val(),
                        "nowCondition": $("#nowCondition").val(),
                        "personalHistory": $("#personalHistory").val(),
                        "allergies": $("#allergies").val(),
                        "familyHistory": $("#familyHistory").val(),
                        "bodyTemperature": $("#bodyTemperature").val(),
                        "bodyWeight": $("#bodyWeight").val(),
                        "heartRate": $("#heartRate").val(),
                        "other": $("#other").val(),
                        "remarks": $("#remarks").val(),
                        "templateName":$("#templateName").val()
                    };
                    var mediDetail = [];
                    var mediList = medicineList.getTableDatas();
                    var projectDetail = [];
                    $("#data-table-simple-medicine > tbody > tr").each(function () {
                        var tmp = {
                            "id": $("input[name='id']", this).val(),
                            "count": $("input[name='count']", this).val(),
                            "description": $("textarea[name='description']", this).val(),
                            "remarks": $("textarea[name='remarks']", this).val(),
                        };
                        if (!isNullOrEmpty(tmp.id) && !isNullOrEmpty(tmp.count)) {
                            mediDetail.push(tmp);
                        }

                    });
                    var d1 = medicineList.getTableDatas();
                    var d2 = projectList.getTableDatas();
                    $("#data-table-simple-project > tbody > tr").each(function () {
                        var tmp = {
                            "id": $("input[name='id']", this).val(),
                            "num": $("input[name='num']", this).val(),
                            "remarks": $("textarea[name='remarks']", this).val(),
                        };
                        if (!isNullOrEmpty(tmp.id) && !isNullOrEmpty(tmp.num)) {
                            projectDetail.push(tmp);
                        }


                    });
                    var hisMedicalModel = {
                        "recordId": $("#recordId").val(),
                        "mediCard": mediCard,
                        "mediDetail": mediDetail,
                        "projects": projectDetail
                    };
                    var jsonData = JSON.stringify(hisMedicalModel);
                    $.ahsjajax(
                        CTX + "/api/medicalTemplate/saveOrUpdatePersonalTemplate.ahsj",
                        jsonData,
                        function (msg) {
                            if (msg.success) {
                                M.toast({html: msg.message});
                                return false;
                            } else {
                                M.toast({html: msg.message});
                                return false;
                            }
                        },
                        null, null, null, function () {
                            M.toast({html: "网络异常"});
                            return false;
                        }, "application/json; charset=UTF-8"
                    );
                    layer.close(index);
                });
            });
        }
    }

    function strToObj(str) {
        str = str.replace(/&/g, "','");
        str = str.replace(/=/g, "':'");
        str = "({'" + str + "'})";
        obj = eval(str);
        return obj;
    }

    function initStepper() {
        var horizStepper = document.querySelector('#horizStepper');
        var horizStepperInstace = new MStepper(horizStepper, {
            // options
            firstActive: 0,
            showFeedbackPreloader: true,
            autoFormCreation: true,
            stepTitleNavigation: true,
            feedbackPreloader: '<div class="spinner-layer spinner-blue-only">...</div>'
        });
        horizStepperInstace.resetStepper();

        function validationFunction(stepperForm, activeStepContent) {
            someValidationPlugin(stepperForm);
            return true;
        }


        function defaultValidationFunction(stepperForm, activeStepContent) {
            var inputs = activeStepContent.querySelectorAll('input, textarea, select');
            for (var i = 0; i < inputs.length; i++) {
                if (!inputs[i].checkValidity()) return false;
            }
            return true;
        }

        $('.btn-reset').on('click', function () {
            horizStepperInstace.openStep(0);
        })

    }

    function addRowForMedicineList(id, drugsNumb, drugsName, drugsSpec, count, description, remarks, stock) {
        var selectRowsIds = medicineList.getIds();
        if (selectRowsIds.length !== 0) {
            for (var k = 0; k < selectRowsIds.length; k++) {
                if (id == selectRowsIds[k]) {
                    id = null;
                }
            }
        }
        if (null !== id) {
            medicineList.addRow({
                "id": id,
                "drugsNumb": drugsNumb,
                "drugsName": drugsName,
                "drugsSpec": drugsSpec,
                "stock": stock,
                "count": count,
                "description": description,
                "remarks": remarks
            });
        }
    }

    function addRowsForMedicineList(ids, json) {

        var selectRowsIds = medicineList.getIds();
        var tmps = [];
        //ids为空说明 选择的药品来源为药方
        if (null == ids) {
            if (selectRowsIds.length !== 0) {
                for (var i = 0; i < json.length; i++) {
                    for (var k = 0; k < selectRowsIds.length; k++) {
                        if (json[i].id == selectRowsIds[k]) {
                            medicineList.removeRow(json[i].id);
                            break;
                        }
                    }
                }
            }
            medicineList.addRows(json);
            //ids不为空说明 选择的药品来源为药库
        } else {
            for (var i = 0; i < json.length; i++) {
                json[i].remarks = null;
            }
            if (selectRowsIds.length !== 0) {
                for (var i = 0; i < ids.length; i++) {
                    for (var k = 0; k < selectRowsIds.length; k++) {
                        if (ids[i] == selectRowsIds[k]) {
                            //使用delete函数将数组元素删除后用empty替代,但数组总长度不会发生变化，因此下列逻辑会出错
                            medicineList.removeRow(ids[i]);
                            break;
                        }
                    }
                }
            }
            for (var i = 0; i < ids.length; ++i) {
                for (var j = 0; j < json.length; j++) {
                    if (undefined !== ids[i] && '' !== ids[i] && null != ids[i] && json[j].id == ids[i]) {
                        tmps[i] = {
                            "id": json[j].id,
                            "drugsNumb": json[j].drugsNumb,
                            "drugsName": json[j].drugsName,
                            "drugsSpec": json[j].drugsSpec,
                            "count": json[j].count,
                            "description": json[j].description,
                            "remarks": json[j].remarks,
                        };
                        break;
                    }
                }
            }
            medicineList.addRows(tmps);

        }
    }

    function addRowForProjectList(id, number, name, pinyinCode, description, assitTypeName, price, num, unit, remarks) {
        var selectRowsIds = projectList.getIds();
        if (selectRowsIds.length !== 0) {
            for (var k = 0; k < selectRowsIds.length; k++) {
                if (id == selectRowsIds[k]) {
                    id = null;
                }
            }
        }
        if (null !== id) {
            projectList.addRow({
                "id": id,
                "number": number,
                "name": name,
                "pinyinCode": pinyinCode,
                "description": description,
                "assitTypeName": assitTypeName,
                "price": price,
                "num": num,
                "unit": unit,
                "remarks": remarks
            });
        }
    }

    function addRowsForProjectList(ids, json) {
        for (var i = 0; i < json.length; i++) {
            json[i].remarks = "";
        }
        var selectRowsIds = projectList.getIds();
        var tmps = [];
        if (null == ids) {
            if (selectRowsIds.length !== 0) {
                for (var i = 0; i < json.length; i++) {
                    for (var k = 0; k < selectRowsIds.length; k++) {
                        if (json[i].id == selectRowsIds[k]) {
                            projectList.removeRow(json[i].id);
                        }
                    }
                }
            }
            projectList.addRows(json);
        } else {
            if (selectRowsIds.length !== 0) {
                for (var i = 0; i < ids.length; i++) {
                    for (var k = 0; k < selectRowsIds.length; k++) {
                        if (ids[i] == selectRowsIds[k]) {
                            projectList.removeRow(ids[i]);
                        }
                    }
                }
            }
            for (var i = 0; i < ids.length; ++i) {
                for (var j = 0; j < json.length; j++) {
                    if (undefined !== ids[i] && '' !== ids[i] && null != ids[i] && json[j].id == ids[i]) {
                        tmps[i] = {
                            "id": json[j].id,
                            "number": json[j].number,
                            "name": json[j].name,
                            "pinyinCode": json[j].pinyinCode,
                            "description": json[j].description,
                            "assitTypeName": json[j].assitTypeName,
                            "price": json[j].price,
                            "num": json[j].hisProjectNum,
                            "unit": json[j].unit,
                            "remarks": json[j].remarks,
                        }
                    }
                }
            }
            projectList.addRows(tmps);
        }
    }

    //添加病历模板
    function addMedical(json,prescriptionIsusable,combineIsusable,prescriptionId,combineId) {
        //添加病历信息
        if(!isNullOrEmpty(json.id)) {
            changeInputValue("chiefcomplaint", json.chiefcomplaint);
            changeInputValue("personalHistory", json.personalHistory);
            changeInputValue("allergies", json.allergies);
            changeInputValue("familyHistory", json.familyHistory);
            changeInputValue("other", json.other);
            changeInputValue("nowCondition", json.nowCondition);
            changeInputValue("hiscondition", json.hiscondition);

            //添加药方信息
            if(prescriptionIsusable != '不可正常使用'&&prescriptionId!=0) {
                if (!isNullOrEmpty(json.prescriptionId)) {
                    addPrescription(json.prescriptionId);
                }
                ;
            }
            if(combineIsusable != '不可正常使用'&&combineId!=0) {
                if (!isNullOrEmpty(json.combineId)) {
                    addCombineProject(json.combineId);
                }
            }
            if(prescriptionId!=0 &&combineId!=0) {
                if (prescriptionIsusable == '不可正常使用' && combineIsusable == '不可正常使用') {
                    dialog.warn("药方与组合项目均不可正常使用，请自行添加");
                }else if(prescriptionIsusable == '不可正常使用' && combineIsusable != '不可正常使用') {
                    dialog.warn("药方不可正常使用，请自行添加");
                }else if(prescriptionIsusable != '不可正常使用' && combineIsusable == '不可正常使用') {
                    dialog.warn("组合项目不可正常使用，需要请自行添加");
                }
            }else if(prescriptionId!=0 &&combineId ==0) {
                if (prescriptionIsusable == '不可正常使用' && combineIsusable != '不可正常使用') {
                    dialog.warn("药方不可正常使用，请自行添加");
                }
            }else if(prescriptionId==0 &&combineId!=0) {
                if (prescriptionIsusable != '不可正常使用' && combineIsusable == '不可正常使用') {
                    dialog.warn("组合项目不可正常使用，需要请自行添加");
                }
            }
        }else {
            dialog.warn("无可添加的病历信息");
        }
    }

    function addPrescription(id) {
        if (id != null && id != "" && id != undefined) {
            $.ahsjajax(
                CTX + "/api/treatmentplan/detailsForByPrescriptionId.ahsj?token=" + TOKEN,
                {"prescriptionId": id},
                function (data) {
                    if (!isNullOrEmpty(data)) {
                        addRowsForMedicineList(null, data);
                    }
                },
                function () {
                    M.toast({html: "网络异常"});
                    return false;
                }
            );
        } else {
            dialog.warn("请选择需要添加的药方")
        }
    }

    function addCombineProject(id) {
        if (id != null && id != "" && id != undefined) {
            $.ahsjajax(
                CTX + "/api/treatmentplan/project/details.ahsj?token=" + TOKEN,
                {"combinationId":id},
                function (data) {
                    addRowsForProjectList(null,data);
                },
                function () {
                    M.toast({html: "网络异常"});
                    return false;
                }
            );}
    }

    function remove(id) {
        medicineList.removeRow(id);
    }

    function removeForProject(id) {
        projectList.removeRow(id);
    }

    function ahsjSerialize(formId) {
        var params = {};
        $(formId).find("input[type='text']").each(function (i) {
            if (this.id) {
                var id = this.id;
                var value = this.value;
                params[id] = value;
            } else {
                var id = this.name;
                var value = this.value;
                params[id] = value;
            }
        });
        $(formId).find("input[type='password']").each(function (i) {
            var id = this.id;
            var value = this.value;
            params[id] = value;
        });
        $(formId).find("textarea").each(function (i) {
            var id = this.id;
            var value = this.value;
            params[id] = value;
        });
        $(formId).find("select").each(function (i) {
            var id = this.id;
            var value = $("#" + this.id).find("option:selected").text();
            params[id] = value;
        });
        $(formId).find("input[type='number']").each(function (i) {
            var id = this.id;
            var value = this.value;
            params[id] = value;
        });
        return params;
    }


    function printShow() {
        var number =$("#number").val()
        dialog.confirm('确定打印吗?', function (index, layero) {
            if (number != "" && number != null && number != undefined) {
                var url = CTX + "/api/patient/print/index.ahsj?number="+ number+"&token="+TOKEN;
                dialog.showDialog(url, "打印凭证预览", "700px", "700px");
            } else {
                dialog.warn("没有需要打印的内容！")
            }});
    };

    $("input").change(function () {
        $(this).val($(this).val().trim());
    });
    $("#printShow").click(function () {
        printShow();
    })

</script>
</body>
</html>